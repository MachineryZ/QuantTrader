# HFT Quant
本课程是由bilibili中hftquant up主提供的视频内容

## 第一讲 二级市场简介
1. 市场交易规则
    1. 股票
        1. 集合竞价和集合竞价：集合竞价是指再规定时间内接受的买卖申报一次性集中撮合的竞价方式。连续竞价是指对买卖申报逐笔连续撮合的竞价方式
        2. 交易时间：价格优先，时间优先。价格更优的报单更早成交，同样价格的报单先报的先成交
        3. 交易时间：9.15-9.25为开盘集合竞价时间，9.30-11.30，13.00-15.00为连续竞价时间，最后3分钟是收盘集合竞价
        4. 交易单位：通过竞价交易买入股票、基金、权证的，申报数量应当为100股或其整数倍。股价的报价单位为N元每股
        5. 涨跌幅：10%相对于昨日的收盘价，但是也有例外的情况，比如上市交易首日
        6. T+1：T日买入的股票第二日才能卖出
        7. 多空：只能做多不能做空
        8. 手续费和印花税：股票交易需要支付一定的手续费和印花税，手续取决于交易所和券商
    2. 期货
       1. 主流交易所：上海期货交易所、大连商品交易所、郑州商品交易所、中国金融期货交易所，前三个是商品期货交易所，交易品种包括金属、农产品等实物期货，最后一个是金融期货交易所，交易品种包括股指期货和国债期货等金融期货
       2. 交易时间：股票只有白天交易，但是期货有的交易所和品种是有夜盘的，而且白天交易时间也有所不同。白天 大商所，上期所，郑商所：9.00-10.15，10.30-11.30，13.30-15.00；中金所：9.30-11.30，13.00-15.00；夜盘 大商所，郑商所部分品种21.00-23.30；上期所 21.00-1.00（大多数金属），21.00-23.00（部分品种），21.00-2.30（金银），部分无
       3. 交易单位：size，一手为单位，根据商品特性决定，如1吨1手。
       4. 报价单位：N元/xx，xx为单位
       5. 手续费：平仓分为平今仓和平昨仓；手续费不同品种收取方式也不同，有的按照每手收取，有的按照成交额比例收取
       6. 交易规则：双向交易，可做多做空
       7. 交易方式：T+0随时买卖，撮合成交
       8. 保证金比例：不同商品保证金不同
       9. 结算时间：交易所自行决定
    3. 数字货币
       1. 交易时间：7*24，全年无休市
       2. 无涨跌停：虚拟货币交易没有涨跌停限制，股票有涨跌停限制
       3. 交易单位：最小为0.0001BTC，没有股票最少买一手的买入限制
       4. 随时交易：T+0，股票是T+1交易
       5. 提币与变现无时间限制：出金时间任何时候都可以

## 第二讲 常见策略
1. 股票策略
   1. BETA策略和ALPHA策略
      1. BETA：获得绝对收益的策略，也可以分为主观策略和量化策略，包括根据财务和行业研究等做的主观投资。用技术指标选股（通常所用数据为日数据）；以及用更高频的日内数据所作的量化策略等。举例：均线突破
      2. ALPHA：主要为了获得超额收益，即常说的跑赢指数，通常为多音字策略，数据一半来自基本面数据（财务）和量价数据。主要有基本面数据做出的多因子策略通常换仓慢，可能一周一次或者一个月换仓一次；主要由量价因子做出的多因子策略通常换仓频繁，可能每天换仓。也有用更高频的数据做出来的高频alpha策略，跟量价因子的主要区别在于量价因子一般用日数据选股。前一天晚上给出第二天的持仓，第二天白天的时候完成该持仓任务，而高频alpha策略根据实时收到的行情进行交易判断，实时给出当前具体时间点的交易任务。举例：反转因子，买入全市场近期跌幅最多的股票
   2. 其他非常规类型策略：T0策略，已经预测到的趋势，怎么吃到T0内的利润？通过底仓，比如借券，市面上的T0团队通常会通过借券的方式向长线投资者借底仓，到期后归还底仓和一定利息。
2. 期货策略
   1. CTA策略：通常只用相对低频的数据（1min，5min，30min）进行策略研究和交易的期货策略。举例：布林带反转策略（交易开拓者种有很多已经写好的简单cta策略函数），突破下轨开多，回到中线平仓。
   2. 高频策略：从极其短暂的市场变化中寻找利润的策略，所用数据是市场能拿到的最高频率的tick数据（例如0.5s/次），可能在1分钟内就能完成若干次交易。不限于期货。**套利策略**：套利策略也成为价差交易策略，是指再买入或卖出某种交易合约的同时，卖出或买入相关的另一种合约，利用相关市场或相关合约之间的价差变化，期望价差发生有利变化而获利的一类策略。同一品种的跨期套利，两个关联品种套利，跨交易所套利。**趋势策略**：根据微观市场信息变化判断接下来一段时间的价格方向策略。**做市策略**：在盘口流动性较差的品种提供流动性，赚取流动性趋势的利润。
3. 数字货币
   1. 数字货币市场的量化策略与股票和期货策略类似，但是因为该市场是新兴的不成熟的市场，因此在比较热门的17，18年，交易者多而且非理性投资者多，套利策略，搬砖策略和做市策略会有很高的收益。缺点是数字货币交易不受监管，可能会有交易风险。套利例子：假设有一个xyz交易对，X/USDT，X/ETH，ETH/USDT，这三个交易对，一旦相互乘积不是1，则存在套利机会（不考虑手续费的情况）。

## 第三讲 指数数据

1. 指数截面数据
   1. 股价指数（股市指数、股票指数）包含多种股票，是反映市场上组成股票价值的一个数据。它通常被用于展现组成股票的共通特性，例如在同一个交易所交易，属于同一个产业，或有相同的市值。
   2. 截面数据又称为切片数据。A股的截面数据是根据指定的时间间隔进行一次检查，如果该时间段内有动作（报单撤单），就生成一次快照（snapshot）并推送出来。
2. 原始指数数据
   1. 000905 中证500
   2. 399006 创业板指
   3. trading day（交易日期）；timestep（时间戳，000开头指数，上交所编制，5秒一个；399开头指数，深交所编制，3秒一个），exchangeid（上海SSE，深圳SZE）；instrumentid（指数代码）；precloseind（index昨收价）；openindex（指数开盘价）；closeindex（指数收盘价，只有3点才会推送，其他时刻为0）；highindex（到目前为止最高的index价格）；lowindex（到目前为止最低的index价格）；lastindex（截取截面时最新的index价格）；turnover（所有成分股的总成交额）；totalvolume（所有成分股的总的成交量）
   4. 由于不同指数的频率不一样，使用时需要统一格式。比如9：33：21有一个数据，下一个数据应该是9：33：26，所以9：33：24秒的时候的数据是由9：33：26填充到9：33：24的时候。
3. 常用指数
   1. 上证指数：包含所有在上交所上市的股票
   2. 深证成指：包含所有在深交所上市的股票
   3. 上证50：
   4. 沪深300：大盘股指数，上海和深圳两个交易所选出来最具市场影响力的300个大市值公司股票作为权重计算出的指数。用来反映沪深证券市场的整体状况。具体方法：1）最近一年的A股日均成交金额由高到低排名，剔除排名后50%的股票。2）对剩余股票按照最近一年A股日均总市值由高到低排名，选取前300名股票作为指数样本。
   5. 中证500：小盘股指数。选取办法：1）在样本空间中剔除沪深300指数样本股及最近一年日均总市值排名前300名的股票，筛选标准是最近一年日均总市值排名前300名的股票后剩余股票总市值排名在前500名的股票。2）将剩余股票按照最近一年（新股上市以来）的最近一年日均成交金额由高到低排名，剔除排名后20%的股票。3）将剩余股票，按照最近一年日均总市值由高到低排名，选取排名在前500名的股票组成中证500的样本股。
   6. 中证1000：
   7. 创业板综：
   8. 创业板指：
   9. 中小板指：
   10. 中小板综：
   11. 注意：1）指数是按照调整市值加权（不同市值同样涨1%，对指数的影响不一样）2）成分股分红时，不修正指数，指数自然回落。3）同花顺种的白线/黄线，白线是加权价格，黄线是等权价格。4）原始数据毛刺很多，需要平滑处理。比如温氏股份（300498）在创业板指（399006）的权重占比高达8%。

## 第四讲：个股数据
1. 个股截面数据：
   1. level2截面数据，有十挡orderbook。外网上只能拿到level1截面数据，有五档orderbook，也缺少部分columns。level2截面数据只能在交易所托管机房才能拿到。
   2. Timestamp，时间戳；TradingDay，交易日期；LastPrice，截取截面数据时最新的成交价；OpenPrice，开盘价；ClosePrice，收盘价；HighPrice，最高价；LowPrice，最低价；TotalTradeVolume，到目前为止个股总成交量；TotalTradeValue，到目前为止个股总成交额；TradeCount，到目前为止总成交笔数。
   3. 盘口数据：TotalBidVolume，TotalAskVolume全档买盘或者卖盘的总挂单量（注意档位）；WeightedAvgBidPrice, WeightedAvgAskPrice，全档挂单量加权买价和加权卖价；Bid/AskPrice1，一档买价和一档卖价。1是第一档的意思，总共有十挡，1-9，A（第十档）；BidVolume1/AskVolume1，一档的买量和一档卖量；BidCount1，AskCount1，一档买单个数，一档卖单个数。挂单个数1，挂单量1000，表示有1一个单里面挂了1000手；挂单个数10，挂单量1000，表示有10个100手的挂单。
   4. spread，盘口宽度，askprice1 - bidprice1，盘口宽度越小代表流动性越好（里面交易的人越有可能被撮合）。
2. level2 逐笔交易
   1. 逐笔数据一般是针对深交所的股票而言（000和300开头）。上交所（600开头）只有trade逐笔数据，且为每3秒推送一次，使用价值不大。
   2. 逐笔委托，order数据：OrderIndex，报单编号，从1开始，分group连续（比如，交易所把所有股票分为5个group）。不同股票OrderIndex可能相同。OrderIndex与trade数据种的BuyIndex或者SellIndex一一对应；OrderTime，交易所收到报单的时间，注意和委托时间区分，两者有时间延时；Price，报单价格，只有在限价单的时候才有效，Price是最差成交价格；Volume，股数；FunctionCode，报单方向，1是买单，2是卖单；InstrumentID，证券代码，6位数；OrderKind，报单类型，1是市价单，2是现价单，u是本方最优价。市价：Order到达交易所时，交易所将用对手价一档申报，如果部分成交时，剩余量变为挂单。考虑：AskPrice1是10块，20手市价买单，那么AskPrice1会上移，BidPrice1会变成10块钱10手。假如，股票价格在快速上涨，想要购买：1）申报一个涨停价的限价单，但是成交价无法被控制，购买量大的时候，平均成交价格会比较高。2）申报一个市价单，那么这个单会成交一部分，剩下的单会成为1档挂单，这样至少买入成本不会太高。本方最优价：Order到达交易所时，Order会被挂单在本方1档价格，适用于买一只股票，却又不急于成交。
   4. EOD数据。日线级别数据，也是财务数据。

## 第五讲
1. 因子测试介绍
   1. 国内量化交易历史，2010-2015年，最受欢迎的量化策略是股指日内策略，大部分私募都会采用第三方的程序化交易平台，如TB开拓者，金字塔，MC等，这些平台的优点是回测、优化、模拟、实盘都是同一个程序，并且编程容易上手，且平台会自己去维护数据库，门槛很低，很多初创公司都会用这类平台。在这些第三方平台实现的策略主要是基于规则型的策略，满足一定条件就买入/卖出，通常是通道突破，指标，波动，K线形态组成的一些信号条件或者过滤条件，达到条件后进行交易。我们成这样的策略为规则型策略。这些策略上手比较容易，如果一个团队管理的规模在小几百万到小几千万的范围内的话，储备50个这样的策略同时跑就可以了。在以前竞争不激的时候，这类交易确实取得了很好的收益，比如15年的股指，16年的商品，但是17年开始就没有以前那么辉煌了，17年的中位数应该是0值以下，后面会说到这类策略的弊端。
2. 什么是因子测试。
   1. 利用数学表达式和历史数据计算得到因子值，然后根据因子值来生成仓位信息。接着我们就可以根据仓位来生成PNL和统计指标
~~~python
buy = factor > open_threshold
sell = factor < -open_threshold
signal = np.array([0] * len(factor))
signal[buy] = 1
signal[sell] = -1
position_pos = np.array([np.nan] * len(factor))
position_pos[0] = 0
position_pos[(signal == 1) & (next_ask > 0) & (next_bid > 0)] = 1
position_pos[(factor < -close_threshold) & (next_bid > 0)] = 0
~~~
   2. 因子策略优势：1）开发策略更高效，更易于维护。
~~~pseudo
计算指标/形态
获取仓位
if 仓位为0：
   根据条件判断买入卖出
elif 仓位大于0：
   根据条件判断卖出平仓
elif 仓位小于0：
   根据条件判断买入平仓
~~~
~~~python
# 使用因子
index_pmr_period = np.log(df["index"]/df["index"].shift(period))
index_pmr_period = index_pmr_preiod.replace(np.nan, 0)
df["x_index_pmr_%i"%period] = tanh(index_pmr_period, bound=1, alpha=2000)
~~~
   3. 易于管理，信号组合更加科学：基于规则性的策略，不同策略之间难以组合，只能通过等权/均值方差模型等方法分配资金，构建投资组合，无法对信号做到增强。耳朵各因子可以利用机器学习等方法对信号进行增强，策略的鲁棒性更好。实际上，基于统计模型相比基于灵感的规则的程序员交易模型要四班很多，但是也正是因为建模过程四班，因此比较容易规模化，也更方便做更严谨的测试。
   4. 运行速度更加高效，传统的规则型策略只能逐tick进行回测，而因子的回测往往采用向量计算的方法，速度会快上很多


2. 因子分类
   1. 时序因子：计算一个合约的时间序列，根据这个时间序列进行择时进出场。用途包括日内交易，算法交易，多头策略。
   2. alpha因子：计算出一个股票池的截面数据，根据因子值将股票分成若干组，进行选股调仓。用途包括高频alpha测率

**单因子分析流程**
**灵感来源**。内部知识补充：自己做T0的思考，想办法形成因子。量价特征数理统计，改造经典量价公式，通过深挖现有数据构造更好的量价因子。外部刺激：专业社区，公众号，国内外券商研报 

**实现因子的过程**。将自己的想法用代码实现成因子。实现因子过程中画出因子的图，看是否跟预想中的一致，主要是看，大体上看是否是一个平稳序列，没有异常值；取值大的地方是否因子的值比较大（是否捕捉了行情）；取值大的地方是否是自己想要的点位（是否捕捉到了想要的行情）。实现因子后，看一下因子的前瞻收益，相关系数，和回测报告。观察：因子的方向是不是和预想中的一致；因子的收益是否稳定，一般正向因子在mide price+不计手续费的情况下都可以做出好看的pnl曲线；交易次数，持仓时间是否和预想的一致（交易次数太少，持仓时间太短都是不合理的）。看一下各个股票的开平仓点位是否合理。如果做出来的因子感觉比较合理后，可以根据自己的需要简单调整一下阈值参数。

**评价指标与回测的一些细节** 均值希望是0，所以标准差应该比均值要大很多。num，总交易次数；profit，单笔盈利；holdtime，单笔持仓时间；profittotal，总利润；winrate，胜率。高频交易中，我们关注比较多的会是交易次数和单笔盈利。而夏普反而不是很在乎，与低频不一样。手续费的设置，根据需求来确定是否设置手续费，如果希望得到的因子出发交易的次数尽可能多，那么可以不设置手续费，如果需要用因子来做T0，那么手续费应该设为单边万7





